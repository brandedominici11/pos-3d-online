<<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Tienda 3D con Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D1117;
            color: #c9d1d9;
            padding-top: 80px; /* Adjusted for new auth elements */
            padding-bottom: 20px; 
        }
        .card-glass,
        .modal-glass-content {
            background-color: rgba(30, 37, 50, 0.6);
            backdrop-filter: blur(10px) saturate(180%);
            -webkit-backdrop-filter: blur(10px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .text-main { color: #e6edf3; }
        .text-secondary { color: #7d8590; }
        .text-label { color: #afb8c1; }
        .form-input-custom,
        .form-select-custom,
        .form-file-custom {
            background-color: rgba(13, 17, 23, 0.5);
            border-color: rgba(255, 255, 255, 0.15);
            color: #e6edf3;
            border-width: 1px;
            border-radius: 0.5rem;
            padding: 0.625rem 0.875rem;
            width: 100%;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .form-input-custom::placeholder { color: #7d8590; }
        .form-input-custom:focus,
        .form-select-custom:focus,
        .form-file-custom:focus {
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
            outline: none;
        }
        .form-file-custom::-webkit-file-upload-button { visibility: hidden; }
        .form-file-custom::before {
            content: 'Seleccionar archivo';
            display: inline-block;
            background: rgba(88, 166, 255, 0.2);
            border: 1px solid rgba(88, 166, 255, 0.5);
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            outline: none;
            white-space: nowrap;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            color: #58a6ff;
            transition: background-color 0.2s ease;
        }
        .form-file-custom:hover::before { background-color: rgba(88, 166, 255, 0.3); }
        .modal { display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.7); align-items: center; justify-content: center; padding: 1rem; z-index: 50; }
        .modal.active { display: flex; }
        #message-modal-text pre { white-space: pre-wrap; word-wrap: break-word; max-height: 60vh; overflow-y: auto; text-align: left; background-color: rgba(13, 17, 23, 0.7); color: #e6edf3; padding: 1rem; border-radius: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.1); }
        .header-bg { background-color: rgba(13, 17, 23, 0.7); backdrop-filter: blur(8px) saturate(150%); -webkit-backdrop-filter: blur(8px) saturate(150%); border-bottom: 1px solid rgba(255, 255, 255, 0.08); position: fixed; top: 0; left: 0; right: 0; z-index: 20; }
        .nav-bg { background-color: transparent; }
        .tab-button { color: #7d8590; border-bottom-width: 2px; border-color: transparent; transition: color 0.2s ease, border-color 0.2s ease; }
        .tab-button:hover { color: #58a6ff; }
        .tab-active-border { border-color: #58a6ff; }
        .tab-active-text { color: #58a6ff; font-weight: 600; }
        .btn { padding: 0.625rem 1.25rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s ease, transform 0.1s ease; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border: 1px solid transparent; }
        .btn:active { transform: translateY(1px); }
        .btn-primary-green { background-color: #238636; color: white; border-color: #2ea043; }
        .btn-primary-green:hover { background-color: #2ea043; }
        .btn-secondary-blue { background-color: #388bfd; color: white; border-color: #58a6ff; }
        .btn-secondary-blue:hover { background-color: #58a6ff; }
        .btn-accent-teal { background-color: #238669; color: white; border-color: #2ea083; }
        .btn-accent-teal:hover { background-color: #2ea083; }
        .btn-warning-orange { background-color: #c9510c; color: white; border-color: #f57831; }
        .btn-warning-orange:hover { background-color: #e16f23; }
        .btn-danger-red { background-color: #da3633; color: white; border-color: #f85149; }
        .btn-danger-red:hover { background-color: #f85149; }
        .btn-neutral-gray { background-color: #21262d; color: #e6edf3; border-color: #30363d; }
        .btn-neutral-gray:hover { background-color: #30363d; }
        .product-image-preview { width: 60px; height: 60px; object-fit: cover; border-radius: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.1); background-color: rgba(13, 17, 23, 0.5); }
        .product-image-sales { width: 100%; height: 100px; object-fit: cover; border-radius: 0.75rem 0.75rem 0 0; }
        .product-image-placeholder, .product-image-sales-placeholder { display: flex; align-items: center; justify-content: center; background-color: rgba(13, 17, 23, 0.5); color: #7d8590; font-size: 0.875rem; border: 1px solid rgba(255, 255, 255, 0.1); }
        .product-image-placeholder { width: 60px; height: 60px; border-radius: 0.5rem; }
        .product-image-sales-placeholder { width: 100%; height: 100px; border-radius: 0.75rem 0.75rem 0 0; }
        #pos-product-list button { text-align: center; }
        #pos-product-list button .p-2 { padding: 0.75rem; }
        #pos-product-list button .text-sm { font-size: 0.875rem; }
        #pos-product-list button .text-xs { font-size: 0.75rem; }
        .loading-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            color: white;
            font-size: 1.2rem;
        }
        .auth-container {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 30; /* Above header content but below modals */
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .user-info {
            color: #c9d1d9;
            font-size: 0.875rem;
            background-color: rgba(30, 37, 50, 0.7);
            padding: 0.375rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <div id="loading-indicator" class="loading-overlay hidden">Cargando datos...</div>

    <header class="header-bg text-white p-4 shadow-lg flex justify-center items-center">
        <h1 class="text-2xl font-bold text-center text-main">Sistema de Gestión Tienda 3D</h1>
    </header>

    <div class="auth-container">
        <span id="user-info-display" class="user-info hidden"></span>
        <button id="google-signin-button" class="btn btn-secondary-blue py-1.5 px-3 text-sm">
            <svg class="inline-block w-4 h-4 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/><path d="M1 1h22v22H1z" fill="none"/></svg>
            Login Google
        </button>
        <button id="signout-button" class="btn btn-danger-red py-1.5 px-3 text-sm hidden">Cerrar Sesión</button>
    </div>


    <nav class="nav-bg shadow-md fixed top-[60px] left-0 right-0 z-10"> <div class="max-w-xl mx-auto flex">
            <button id="tab-inventario" class="tab-button flex-1 py-3 px-2 text-center font-semibold">
                Gestión de Inventario
            </button>
            <button id="tab-pos" class="tab-button flex-1 py-3 px-2 text-center font-semibold">
                Punto de Venta (POS)
            </button>
        </div>
    </nav>

    <main class="flex-grow p-4 max-w-xl mx-auto w-full mt-16"> <section id="content-inventario" class="tab-content active space-y-6">
            <div>
                <h2 class="text-xl font-semibold mb-3 text-main">Materia Prima: Plástico</h2>
                <div class="card-glass p-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="plastic-name" class="block text-sm font-medium text-label mb-1">Nombre del Plástico (ej: PLA Rojo):</label>
                            <input type="text" id="plastic-name" class="form-input-custom" placeholder="PLA Rojo 1kg">
                        </div>
                        <div>
                            <label for="plastic-quantity" class="block text-sm font-medium text-label mb-1">Cantidad Inicial (gramos):</label>
                            <input type="number" id="plastic-quantity" class="form-input-custom" placeholder="1000" min="0">
                        </div>
                    </div>
                    <button id="add-plastic-button" class="w-full btn btn-accent-teal py-2.5 px-4">
                        Agregar Tipo de Plástico
                    </button>

                    <h3 class="text-lg font-semibold mt-6 mb-3 text-main">Stock de Plásticos</h3>
                    <div id="plastic-stock-list" class="space-y-3">
                        <p class="text-secondary text-sm">Inicie sesión para ver/cargar plásticos.</p>
                    </div>
                </div>
            </div>

            <div>
                <h2 class="text-xl font-semibold mb-3 text-main">Productos Fabricados</h2>
                <div class="card-glass p-4">
                    <h3 class="text-lg font-semibold mb-3 text-main">Agregar Nuevo Producto Fabricado</h3>
                    <div class="mb-3">
                        <label for="fab-product-name" class="block text-sm font-medium text-label mb-1">Nombre del Producto:</label>
                        <input type="text" id="fab-product-name" class="form-input-custom" placeholder="Ej: Llavero Gato">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <label for="fab-product-price" class="block text-sm font-medium text-label mb-1">Precio de Venta (ARS):</label>
                            <input type="number" id="fab-product-price" class="form-input-custom" placeholder="500.00" step="0.01" min="0">
                        </div>
                        <div>
                            <label for="fab-product-quantity" class="block text-sm font-medium text-label mb-1">Cantidad Fabricada (Unidades):</label>
                            <input type="number" id="fab-product-quantity" class="form-input-custom" placeholder="10" step="1" min="1">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="fab-product-image-input" class="block text-sm font-medium text-label mb-1">Imagen (Opcional):</label>
                        <input type="file" id="fab-product-image-input" class="form-file-custom" accept="image/*">
                        <img id="fab-product-image-preview" class="mt-2 product-image-preview hidden" alt="Vista previa">
                    </div>
                    <div class="mb-3 card-glass p-3 border-none"> <label class="flex items-center space-x-2">
                            <input type="checkbox" id="fab-deduct-plastic-check" class="form-checkbox h-5 w-5 text-sky-500 bg-slate-700 border-slate-600 rounded focus:ring-sky-500">
                            <span class="text-sm text-label">Descontar plástico de materia prima para este lote</span>
                        </label>
                        <div id="fab-plastic-details" class="mt-3 space-y-3 hidden">
                            <div>
                                <label for="fab-plastic-type-select" class="block text-xs font-medium text-label mb-1">Tipo de Plástico Usado:</label>
                                <select id="fab-plastic-type-select" class="form-select-custom">
                                    <option value="">Seleccione un plástico...</option>
                                </select>
                            </div>
                            <div>
                                <label for="fab-plastic-grams-unit" class="block text-xs font-medium text-label mb-1">Gramos de Plástico por Unidad:</label>
                                <input type="number" id="fab-plastic-grams-unit" class="form-input-custom" placeholder="15" min="0.1" step="0.1">
                            </div>
                        </div>
                    </div>
                    <button id="add-fab-product-button" class="w-full btn btn-primary-green py-2.5 px-4">
                        Agregar Producto al Inventario
                    </button>

                    <h3 class="text-lg font-semibold mt-6 mb-3 text-main">Inventario de Productos Fabricados</h3>
                    <div id="fab-product-list" class="space-y-3">
                        <p class="text-secondary text-sm">Inicie sesión para ver/cargar productos.</p>
                    </div>
                </div>
            </div>
            <div class="mt-6 card-glass p-4 space-y-3">
                <h3 class="text-lg font-semibold mb-2 text-main">Opciones Generales de Tienda</h3>
                <button id="generate-store-summary-button" class="w-full btn btn-secondary-blue py-2.5 px-4">
                    Generar Resumen de Ventas del Día
                </button>
                <button id="reset-store-sales-button" class="w-full btn btn-warning-orange py-2.5 px-4">
                    Empezar un Nuevo Día
                </button>
                 <p class="text-xs text-center text-neutral-500 mt-2 hidden">ID de Usuario (para soporte): <span id="user-id-display"></span></p>
            </div>
        </section>

        <section id="content-pos" class="tab-content space-y-6">
            <h2 class="text-xl font-semibold mb-4 text-main">Seleccionar Productos para Vender</h2>
            <div id="pos-product-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-6">
                <p class="text-secondary text-sm col-span-full">Inicie sesión para ver productos disponibles.</p>
            </div>

            <div class="card-glass p-4 mb-6">
                <h3 class="text-lg font-semibold text-main mb-1">Ventas del Día</h3>
                <p id="pos-daily-sales-total" class="text-2xl font-bold text-green-400">ARS 0.00</p>
            </div>
            <h3 class="text-lg font-semibold mb-3 text-main">Carrito de Compras</h3>
            <div class="card-glass p-4">
                <div id="pos-cart-items" class="space-y-2 mb-3 min-h-[40px]">
                    <p class="text-secondary text-sm">El carrito está vacío.</p>
                </div>
                <div class="border-t border-[rgba(255,255,255,0.1)] pt-3">
                    <div class="flex justify-between items-center font-bold text-lg text-main">
                        <span>Total:</span>
                        <span id="pos-cart-total" class="text-green-400">ARS 0.00</span>
                    </div>
                </div>
                <div class="mt-4 space-y-2">
                    <button id="pos-clear-cart-button" class="w-full btn btn-danger-red py-2.5 px-4">
                        Vaciar Carrito
                    </button>
                    <button id="pos-checkout-button" class="w-full btn btn-primary-green py-2.5 px-4">
                        Finalizar Venta
                    </button>
                </div>
            </div>
        </section>
    </main>

    <div id="message-modal" class="modal">
        <div class="modal-glass-content p-6 max-w-md w-full">
            <h3 id="message-modal-title" class="text-lg font-semibold mb-3 text-main">Mensaje</h3>
            <div id="message-modal-text" class="text-sm text-label mb-4"></div>
            <button id="message-modal-close" class="w-full btn btn-secondary-blue py-2 px-4">
                Entendido
            </button>
        </div>
    </div>

    <div id="edit-fab-product-modal" class="modal">
        <div class="modal-glass-content p-6 max-w-lg w-full">
            <h3 class="text-lg font-semibold mb-4 text-main">Modificar Producto Fabricado</h3>
            <input type="hidden" id="edit-fab-product-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="edit-fab-product-name" class="block text-sm font-medium text-label mb-1">Nombre:</label>
                    <input type="text" id="edit-fab-product-name" class="form-input-custom">
                </div>
                <div>
                    <label for="edit-fab-product-price" class="block text-sm font-medium text-label mb-1">Precio (ARS):</label>
                    <input type="number" id="edit-fab-product-price" class="form-input-custom" step="0.01" min="0">
                </div>
            </div>
            <div class="mt-4">
                <label for="edit-fab-product-image-input" class="block text-sm font-medium text-label mb-1">Cambiar Imagen (Opcional):</label>
                <input type="file" id="edit-fab-product-image-input" class="form-file-custom" accept="image/*">
                <div class="flex items-center mt-2">
                    <img id="edit-fab-product-image-preview" class="product-image-preview" alt="Imagen actual">
                    <button id="remove-edit-fab-image-button" class="ml-3 btn btn-danger-red px-2 py-1 text-xs hidden">Quitar</button>
                </div>
            </div>
            <hr class="my-4 border-[rgba(255,255,255,0.1)]">
            <div>
                <h4 class="text-md font-semibold mb-2 text-main">Agregar más Stock (Fabricar Lote Adicional)</h4>
                <div class="mb-3">
                    <label for="add-stock-quantity" class="block text-sm font-medium text-label mb-1">Cantidad Adicional a Fabricar:</label>
                    <input type="number" id="add-stock-quantity" class="form-input-custom" placeholder="0" min="0">
                </div>
                <div class="mb-3 card-glass p-3 border-none">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="add-stock-deduct-plastic-check" class="form-checkbox h-5 w-5 text-sky-500 bg-slate-700 border-slate-600 rounded focus:ring-sky-500">
                        <span class="text-sm text-label">Descontar plástico para este lote adicional</span>
                    </label>
                    <div id="add-stock-plastic-details" class="mt-3 space-y-3 hidden">
                        <div>
                            <label for="add-stock-plastic-type-select" class="block text-xs font-medium text-label mb-1">Tipo de Plástico Usado:</label>
                            <select id="add-stock-plastic-type-select" class="form-select-custom">
                                <option value="">Seleccione un plástico...</option>
                            </select>
                        </div>
                        <div>
                            <label for="add-stock-plastic-grams-unit" class="block text-xs font-medium text-label mb-1">Gramos de Plástico por Unidad (para este lote):</label>
                            <input type="number" id="add-stock-plastic-grams-unit" class="form-input-custom" placeholder="Gramos por unidad" min="0.1" step="0.1">
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="cancel-edit-fab-button" class="btn btn-neutral-gray py-2 px-4">
                    Cancelar
                </button>
                <button id="save-edit-fab-button" class="btn btn-primary-green py-2 px-4">
                    Guardar Cambios y/o Agregar Stock
                </button>
            </div>
        </div>
    </div>

    <div id="edit-plastic-stock-modal" class="modal">
        <div class="modal-glass-content p-6 max-w-sm w-full">
            <h3 class="text-lg font-semibold mb-4 text-main">Actualizar Stock de Plástico</h3>
            <input type="hidden" id="edit-plastic-id">
            <p class="text-label mb-1">Plástico: <span id="editing-plastic-name" class="font-semibold text-main"></span></p>
            <div class="mb-4">
                <label for="update-plastic-quantity" class="block text-sm font-medium text-label mb-1">Nueva Cantidad Total (gramos):</label>
                <input type="number" id="update-plastic-quantity" class="form-input-custom" min="0">
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="cancel-update-plastic-button" class="btn btn-neutral-gray py-2 px-4">
                    Cancelar
                </button>
                <button id="save-update-plastic-button" class="btn btn-accent-teal py-2 px-4">
                    Actualizar Cantidad
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importaciones de Firebase (versión 11.8.1)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        // Removed clearPersistence and terminate from this import as they were causing issues and not actively used.
        import { getFirestore, collection, doc, addDoc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDkp0U0wsiY80JyU_fJwkLEL1XfPdjRuEQ",
            authDomain: "pagenico-c197b.firebaseapp.com",
            projectId: "pagenico-c197b",
            storageBucket: "pagenico-c197b.firebasestorage.app",
            messagingSenderId: "538626743627",
            appId: "1:538626743627:web:8392d4f77ea51563279cce",
            measurementId: "G-HLTC26PE6B"
        };
        
        // Inicializar Firebase App
        const fbApp = initializeApp(firebaseConfig);
        const db = getFirestore(fbApp);
        const auth = getAuth(fbApp);
        const analytics = getAnalytics(fbApp);
        const provider = new GoogleAuthProvider();

        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId; // Use Firebase appId as fallback

        let userId = null; 
        let unsubscribePlastics = () => {};
        let unsubscribeProducts = () => {};
        let unsubscribeSales = () => {};


        // IDs de elementos DOM
        const googleSigninButton = document.getElementById('google-signin-button');
        const signoutButton = document.getElementById('signout-button');
        const userInfoDisplay = document.getElementById('user-info-display');

        const tabInventarioButton = document.getElementById('tab-inventario');
        const tabPosButton = document.getElementById('tab-pos');
        const contentInventario = document.getElementById('content-inventario');
        const contentPos = document.getElementById('content-pos');
        const loadingIndicator = document.getElementById('loading-indicator');
        // const userIdDisplay = document.getElementById('user-id-display'); // Now part of userInfoDisplay

        // Gestión de Plástico
        const plasticNameInput = document.getElementById('plastic-name');
        const plasticQuantityInput = document.getElementById('plastic-quantity');
        const addPlasticButton = document.getElementById('add-plastic-button');
        const plasticStockListDiv = document.getElementById('plastic-stock-list');

        // Gestión de Productos Fabricados (Agregar)
        const fabProductNameInput = document.getElementById('fab-product-name');
        const fabProductPriceInput = document.getElementById('fab-product-price');
        const fabProductQuantityInput = document.getElementById('fab-product-quantity');
        const fabProductImageInput = document.getElementById('fab-product-image-input');
        const fabProductImagePreview = document.getElementById('fab-product-image-preview');
        const fabDeductPlasticCheck = document.getElementById('fab-deduct-plastic-check');
        const fabPlasticDetailsDiv = document.getElementById('fab-plastic-details');
        const fabPlasticTypeSelect = document.getElementById('fab-plastic-type-select');
        const fabPlasticGramsUnitInput = document.getElementById('fab-plastic-grams-unit');
        const addFabProductButton = document.getElementById('add-fab-product-button');
        const fabProductListDiv = document.getElementById('fab-product-list');

        // POS
        const posProductListDiv = document.getElementById('pos-product-list');
        const posCartItemsDiv = document.getElementById('pos-cart-items');
        const posCartTotalSpan = document.getElementById('pos-cart-total');
        const posClearCartButton = document.getElementById('pos-clear-cart-button');
        const posCheckoutButton = document.getElementById('pos-checkout-button');
        const posDailySalesTotalSpan = document.getElementById('pos-daily-sales-total');

        // Opciones de Tienda/Feria
        const generateStoreSummaryButton = document.getElementById('generate-store-summary-button');
        const resetStoreSalesButton = document.getElementById('reset-store-sales-button');

        // Modales
        const messageModal = document.getElementById('message-modal');
        const messageModalTitle = document.getElementById('message-modal-title');
        const messageModalText = document.getElementById('message-modal-text');
        const messageModalClose = document.getElementById('message-modal-close');

        const editFabProductModal = document.getElementById('edit-fab-product-modal');
        const editFabProductIdInput = document.getElementById('edit-fab-product-id');
        const editFabProductNameInput = document.getElementById('edit-fab-product-name');
        const editFabProductPriceInput = document.getElementById('edit-fab-product-price');
        const editFabProductImageInput = document.getElementById('edit-fab-product-image-input');
        const editFabProductImagePreview = document.getElementById('edit-fab-product-image-preview');
        const removeEditFabImageButton = document.getElementById('remove-edit-fab-image-button');
        const addStockQuantityInput = document.getElementById('add-stock-quantity');
        const addStockDeductPlasticCheck = document.getElementById('add-stock-deduct-plastic-check');
        const addStockPlasticDetailsDiv = document.getElementById('add-stock-plastic-details');
        const addStockPlasticTypeSelect = document.getElementById('add-stock-plastic-type-select');
        const addStockPlasticGramsUnitInput = document.getElementById('add-stock-plastic-grams-unit');
        const saveEditFabButton = document.getElementById('save-edit-fab-button');
        const cancelEditFabButton = document.getElementById('cancel-edit-fab-button');

        const editPlasticStockModal = document.getElementById('edit-plastic-stock-modal');
        const editPlasticIdInput = document.getElementById('edit-plastic-id');
        const editingPlasticNameSpan = document.getElementById('editing-plastic-name');
        const updatePlasticQuantityInput = document.getElementById('update-plastic-quantity');
        const saveUpdatePlasticButton = document.getElementById('save-update-plastic-button');
        const cancelUpdatePlasticButton = document.getElementById('cancel-update-plastic-button');

        // Estado de la Aplicación
        let plastics = [];
        let products = [];
        let cart = [];
        let totalSales = 0;
        let completedSales = [];

        let currentFabProductImageBase64 = null;
        let editingFabProductImageBase64 = null;

        // --- Funciones de Autenticación ---
        googleSigninButton.addEventListener('click', async () => {
            try {
                loadingIndicator.textContent = "Iniciando sesión con Google...";
                loadingIndicator.classList.remove('hidden');
                await signInWithPopup(auth, provider);
                // onAuthStateChanged will handle UI updates and listener setup
                showMessage("Inicio de Sesión Exitoso", "Has iniciado sesión con Google.");
            } catch (error) {
                console.error("Error durante inicio de sesión con Google:", error);
                showMessage("Error de Inicio de Sesión", `No se pudo iniciar sesión con Google: ${error.message}`);
                loadingIndicator.classList.add('hidden');
            }
        });

        signoutButton.addEventListener('click', async () => {
            try {
                loadingIndicator.textContent = "Cerrando sesión...";
                loadingIndicator.classList.remove('hidden');
                await signOut(auth);
                // onAuthStateChanged will handle UI updates and listener teardown
                showMessage("Sesión Cerrada", "Has cerrado sesión.");
            } catch (error) {
                console.error("Error durante cierre de sesión:", error);
                showMessage("Error al Salir", `No se pudo cerrar sesión: ${error.message}`);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });


        // --- Funciones de Colecciones de Firestore ---
        function plasticsCollectionRef() {
            if (!userId) throw new Error("User not authenticated for plastics collection");
            return collection(db, "artifacts", appId, "users", userId, "plastics");
        }

        function plasticDocRef(docId) {
            if (!userId) throw new Error("User not authenticated for plastic doc");
            return doc(db, "artifacts", appId, "users", userId, "plastics", docId);
        }

        function productsCollectionRef() {
            if (!userId) throw new Error("User not authenticated for products collection");
            return collection(db, "artifacts", appId, "users", userId, "products");
        }

        function productDocRef(docId) {
            if (!userId) throw new Error("User not authenticated for product doc");
            return doc(db, "artifacts", appId, "users", userId, "products", docId);
        }
        
        function completedSalesCollectionRef() {
            if (!userId) throw new Error("User not authenticated for completedSales collection");
            return collection(db, "artifacts", appId, "users", userId, "completedSales");
        }

        // --- Funciones Auxiliares para Imágenes ---
        function handleImagePreview(fileInput, previewElement, base64VarSetter) {
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewElement.src = e.target.result;
                    previewElement.classList.remove('hidden');
                    base64VarSetter(e.target.result);
                }
                reader.readAsDataURL(file);
            } else {
                previewElement.classList.add('hidden');
                previewElement.src = '';
                base64VarSetter(null);
            }
        }
        fabProductImageInput.addEventListener('change', () => handleImagePreview(fabProductImageInput, fabProductImagePreview, (val) => currentFabProductImageBase64 = val));
        editFabProductImageInput.addEventListener('change', () => handleImagePreview(editFabProductImageInput, editFabProductImagePreview, (val) => {
            editingFabProductImageBase64 = val;
            removeEditFabImageButton.classList.toggle('hidden', !val);
        }));
        removeEditFabImageButton.addEventListener('click', () => {
            editFabProductImagePreview.src = '';
            editFabProductImagePreview.classList.add('hidden');
            editFabProductImageInput.value = '';
            editingFabProductImageBase64 = null;
            removeEditFabImageButton.classList.add('hidden');
        });

        // --- Funciones de Modales y Mensajes ---
        function showModal(modalElement) { modalElement.classList.add('active'); }
        function hideModal(modalElement) {
            modalElement.classList.remove('active');
            fabProductImagePreview.classList.add('hidden'); fabProductImagePreview.src = ''; fabProductImageInput.value = ''; currentFabProductImageBase64 = null;
            editFabProductImagePreview.src = ''; editFabProductImagePreview.classList.add('hidden'); editFabProductImageInput.value = ''; editingFabProductImageBase64 = null; removeEditFabImageButton.classList.add('hidden');
            addStockQuantityInput.value = '0'; addStockDeductPlasticCheck.checked = false; addStockPlasticDetailsDiv.classList.add('hidden'); addStockPlasticTypeSelect.value = ''; addStockPlasticGramsUnitInput.value = '';
        }
        function showMessage(title, textContent, isHtml = false) {
            messageModalTitle.textContent = title;
            if (isHtml) { messageModalText.innerHTML = textContent; }
            else { messageModalText.innerHTML = `<p class="text-label">${textContent.replace(/\n/g, '<br>')}</p>`; }
            showModal(messageModal);
        }
        messageModalClose.addEventListener('click', () => hideModal(messageModal));
        cancelEditFabButton.addEventListener('click', () => hideModal(editFabProductModal));
        cancelUpdatePlasticButton.addEventListener('click', () => hideModal(editPlasticStockModal));

        // --- Lógica de Pestañas ---
        function setActiveTab(activeButton, activeContent) {
            [tabInventarioButton, tabPosButton].forEach(b => { b.classList.remove('tab-active-text', 'tab-active-border'); b.classList.add('text-gray-400'); });
            activeButton.classList.add('tab-active-text', 'tab-active-border'); activeButton.classList.remove('text-gray-400');
            [contentInventario, contentPos].forEach(c => c.classList.remove('active'));
            activeContent.classList.add('active');
            localStorage.setItem('activeStoreTab', activeButton.id);
        }

        // --- Gestión de Materia Prima (Plástico) con Firestore ---
        function renderPlasticStock() {
            plasticStockListDiv.innerHTML = '';
            if (!userId) {
                 plasticStockListDiv.innerHTML = '<p class="text-secondary text-sm">Inicie sesión para ver/cargar plásticos.</p>';
                 populatePlasticSelects(); // Clear selects if logged out
                 return;
            }
            if (plastics.length === 0) {
                plasticStockListDiv.innerHTML = '<p class="text-secondary text-sm">No hay plásticos registrados.</p>';
            } else {
                const sortedPlastics = [...plastics].sort((a, b) => a.name.localeCompare(b.name));
                sortedPlastics.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'bg-[rgba(22,27,34,0.8)] p-3 rounded-lg shadow flex justify-between items-center';
                    div.innerHTML = `
                        <div>
                            <p class="font-medium text-main">${p.name}</p>
                            <p class="text-sm text-sky-400">${p.quantity.toLocaleString()} gramos</p>
                        </div>
                        <div class="flex space-x-2">
                            <button data-id="${p.id}" class="edit-plastic-stock-button text-yellow-400 hover:text-yellow-300 text-xs font-medium p-1">Actualizar</button>
                            <button data-id="${p.id}" class="delete-plastic-button text-red-400 hover:text-red-300 text-xs font-medium p-1">Eliminar</button>
                        </div>
                    `;
                    plasticStockListDiv.appendChild(div);
                });
            }
            populatePlasticSelects();
            document.querySelectorAll('.edit-plastic-stock-button').forEach(btn => btn.addEventListener('click', (e) => openEditPlasticStockModal(e.target.dataset.id)));
            document.querySelectorAll('.delete-plastic-button').forEach(btn => btn.addEventListener('click', (e) => deletePlasticType(e.target.dataset.id)));
        }

        async function addPlasticType() {
            if (!userId) { showMessage("Acción Requerida", "Por favor, inicie sesión para agregar plástico."); return; }
            const name = plasticNameInput.value.trim();
            const quantity = parseInt(plasticQuantityInput.value);
            if (!name || isNaN(quantity) || quantity < 0) {
                showMessage("Error", "Nombre y cantidad válida (positiva) son requeridos para el plástico.");
                return;
            }
            if (plastics.find(p => p.name.toLowerCase() === name.toLowerCase())) {
                showMessage("Error", "Ya existe un plástico con ese nombre.");
                return;
            }
            try {
                await addDoc(plasticsCollectionRef(), { name, quantity });
                plasticNameInput.value = '';
                plasticQuantityInput.value = '';
                showMessage("Éxito", `Plástico "${name}" agregado con ${quantity}g.`);
            } catch (error) {
                console.error("Error agregando plástico:", error);
                showMessage("Error de Base de Datos", "No se pudo agregar el plástico: " + error.message);
            }
        }
        addPlasticButton.addEventListener('click', addPlasticType);

        function openEditPlasticStockModal(plasticId) {
            if (!userId) { showMessage("Acción Requerida", "Por favor, inicie sesión para editar."); return; }
            const plastic = plastics.find(p => p.id === plasticId);
            if (plastic) {
                editPlasticIdInput.value = plastic.id;
                editingPlasticNameSpan.textContent = plastic.name;
                updatePlasticQuantityInput.value = plastic.quantity;
                showModal(editPlasticStockModal);
            }
        }

        saveUpdatePlasticButton.addEventListener('click', async () => {
            if (!userId) { showMessage("Acción Requerida", "Por favor, inicie sesión para guardar."); return; }
            const plasticId = editPlasticIdInput.value;
            const newQuantity = parseInt(updatePlasticQuantityInput.value);
            if (isNaN(newQuantity) || newQuantity < 0) {
                showMessage("Error", "La nueva cantidad debe ser un número no negativo.");
                return;
            }
            const plastic = plastics.find(p => p.id === plasticId);
            if (plastic) {
                try {
                    await updateDoc(plasticDocRef(plasticId), { quantity: newQuantity });
                    hideModal(editPlasticStockModal);
                    showMessage("Éxito", `Stock de "${plastic.name}" actualizado a ${newQuantity}g.`);
                } catch (error) {
                    console.error("Error actualizando stock de plástico:", error);
                    showMessage("Error de Base de Datos", "No se pudo actualizar el stock: " + error.message);
                }
            }
        });

        async function deletePlasticType(plasticId) {
            if (!userId) { showMessage("Acción Requerida", "Por favor, inicie sesión para eliminar."); return; }
            const plasticToDelete = plastics.find(p => p.id === plasticId);
            if (!plasticToDelete) return;

            const isUsed = products.some(p => p.plasticCostPerUnit && p.plasticCostPerUnit.typeId === plasticId);
            if (isUsed) {
                showMessage("Error al Eliminar", `El plástico "${plasticToDelete.name}" no puede ser eliminado porque está referenciado en productos fabricados. Edite esos productos primero.`);
                return;
            }
            
            const confirmDelete = window.confirm(`¿Seguro que deseas eliminar el plástico "${plasticToDelete.name}"? Esta acción no se puede deshacer.`);
            if (confirmDelete) {
                try {
                    await deleteDoc(plasticDocRef(plasticId));
                    showMessage("Plástico Eliminado", `El plástico "${plasticToDelete.name}" ha sido eliminado.`);
                } catch (error) {
                    console.error("Error eliminando plástico:", error);
                    showMessage("Error de Base de Datos", "No se pudo eliminar el plástico: " + error.message);
                }
            }
        }


        function populatePlasticSelects() {
            const selects = [fabPlasticTypeSelect, addStockPlasticTypeSelect];
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="" class="bg-slate-700">Seleccione un plástico...</option>';
                if (userId && plastics.length > 0) { 
                    const sortedPlastics = [...plastics].sort((a, b) => a.name.localeCompare(b.name));
                    sortedPlastics.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = `${p.name} (${p.quantity}g disp.)`;
                        option.className = "bg-slate-700";
                        select.appendChild(option);
                    });
                    if (plastics.find(p => p.id === currentValue)) {
                        select.value = currentValue;
                    } else {
                        select.value = "";
                    }
                } else {
                     select.value = ""; 
                }
            });
        }

        // --- Gestión de Productos Fabricados con Firestore ---
        fabDeductPlasticCheck.addEventListener('change', () => fabPlasticDetailsDiv.classList.toggle('hidden', !fabDeductPlasticCheck.checked));
        addStockDeductPlasticCheck.addEventListener('change', () => addStockPlasticDetailsDiv.classList.toggle('hidden', !addStockDeductPlasticCheck.checked));

        async function addFabProduct() {
            if (!userId) { showMessage("Acción Requerida", "Por favor, inicie sesión para agregar productos."); return; }
            const name = fabProductNameInput.value.trim();
            const price = parseFloat(fabProductPriceInput.value);
            const quantityManufactured = parseInt(fabProductQuantityInput.value);

            if (!name || isNaN(price) || price < 0 || isNaN(quantityManufactured) || quantityManufactured <= 0) {
                showMessage("Error", "Nombre, precio válido, y cantidad fabricada (positiva) son requeridos.");
                return;
            }

            let plasticCostPerUnit = null;
            let totalPlasticNeeded = 0;
            let selectedPlasticForDb = null;
            let plasticUpdateNeeded = false;

            if (fabDeductPlasticCheck.checked) {
                const plasticTypeId = fabPlasticTypeSelect.value;
                const gramsPerUnit = parseFloat(fabPlasticGramsUnitInput.value);
                if (!plasticTypeId || isNaN(gramsPerUnit) || gramsPerUnit <= 0) {
                    showMessage("Error", "Si descuenta plástico, seleccione tipo y especifique gramos por unidad válidos.");
                    return;
                }
                selectedPlasticForDb = plastics.find(p => p.id === plasticTypeId);
                if (!selectedPlasticForDb) {
                    showMessage("Error", "Tipo de plástico seleccionado no válido o no disponible.");
                    return;
                }
                totalPlasticNeeded = gramsPerUnit * quantityManufactured;
                if (selectedPlasticForDb.quantity < totalPlasticNeeded) {
                    showMessage("Error", `Stock insuficiente de ${selectedPlasticForDb.name}. Necesita ${totalPlasticNeeded}g, disponibles ${selectedPlasticForDb.quantity}g.`);
                    return;
                }
                plasticCostPerUnit = { typeId: plasticTypeId, amount: gramsPerUnit, name: selectedPlasticForDb.name };
                plasticUpdateNeeded = true;
            }

            const existingProduct = products.find(p => p.name.toLowerCase() === name.toLowerCase());
            
            try {
                const batch = writeBatch(db);

                if (existingProduct) {
                    const newStock = existingProduct.stock + quantityManufactured;
                    const updateData = {
                        stock: newStock,
                        price: price,
                        image: currentFabProductImageBase64 !== null ? currentFabProductImageBase64 : (existingProduct.image || null)
                    };
                    if (plasticCostPerUnit) {
                        updateData.plasticCostPerUnit = plasticCostPerUnit;
                    }
                    batch.update(productDocRef(existingProduct.id), updateData);
                } else {
                    const newProductRef = doc(productsCollectionRef()); 
                     batch.set(newProductRef, { 
                        name,
                        price,
                        stock: quantityManufactured,
                        image: currentFabProductImageBase64,
                        plasticCostPerUnit
                    });
                }

                if (plasticUpdateNeeded && selectedPlasticForDb && totalPlasticNeeded > 0) {
                    const newPlasticQuantity = selectedPlasticForDb.quantity - totalPlasticNeeded;
                    batch.update(plasticDocRef(selectedPlasticForDb.id), { quantity: newPlasticQuantity });
                }

                await batch.commit();

                showMessage("Éxito", `Producto "${name}" (${quantityManufactured} uds) agregado/actualizado en inventario.`);
                fabProductNameInput.value = ''; fabProductPriceInput.value = ''; fabProductQuantityInput.value = '';
                fabProductImageInput.value = ''; fabProductImagePreview.classList.add('hidden'); fabProductImagePreview.src = ''; currentFabProductImageBase64 = null;
                fabDeductPlasticCheck.checked = false; fabPlasticDetailsDiv.classList.add('hidden'); fabPlasticTypeSelect.value = ''; fabPlasticGramsUnitInput.value = '';

            } catch (error) {
                console.error("Error agregando/actualizando producto fabricado:", error);
                showMessage("Error de Base de Datos", "No se pudo agregar/actualizar el producto: " + error.message);
            }
        }
        addFabProductButton.addEventListener('click', addFabProduct);

        function renderFabProductList() {
            fabProductListDiv.innerHTML = '';
             if (!userId) {
                 fabProductListDiv.innerHTML = '<p class="text-secondary text-sm">Inicie sesión para ver/cargar productos.</p>';
                 return;
            }
            if (products.length === 0) {
                fabProductListDiv.innerHTML = '<p class="text-secondary text-sm">No hay productos fabricados.</p>';
            } else {
                const sortedProducts = [...products].sort((a,b) => a.name.localeCompare(b.name));
                sortedProducts.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'card-glass p-3 flex items-center';
                    let imageHtml = p.image ? `<img src="${p.image}" alt="${p.name}" class="product-image-preview mr-4">` : `<div class="product-image-placeholder mr-4"><span>Sin<br>Img</span></div>`;
                    let plasticInfo = '';
                    if (p.plasticCostPerUnit) {
                        const plasticType = plastics.find(pl => pl.id === p.plasticCostPerUnit.typeId);
                        const plasticTypeName = plasticType ? plasticType.name : (p.plasticCostPerUnit.name || 'Desconocido');
                        plasticInfo = `<p class="text-xs text-slate-400">Usa: ${p.plasticCostPerUnit.amount}g de ${plasticTypeName}</p>`;
                    }

                    div.innerHTML = `
                        ${imageHtml}
                        <div class="flex-grow">
                            <p class="font-medium text-main">${p.name}</p>
                            <p class="text-sm text-sky-400 font-semibold">ARS ${p.price.toFixed(2)}</p>
                            <p class="text-sm text-main">Stock: ${p.stock} uds.</p>
                            ${plasticInfo}
                        </div>
                        <div class="flex flex-col space-y-1 flex-shrink-0 ml-2">
                            <button data-id="${p.id}" class="edit-fab-product-button text-yellow-400 hover:text-yellow-300 text-xs font-medium p-1 text-right">Modificar</button>
                            <button data-id="${p.id}" class="delete-fab-product-button text-red-400 hover:text-red-300 text-xs font-medium p-1 text-right">Eliminar</button>
                        </div>
                    `;
                    fabProductListDiv.appendChild(div);
                });
            }
            document.querySelectorAll('.edit-fab-product-button').forEach(btn => btn.addEventListener('click', (e) => openEditFabProductModal(e.target.dataset.id)));
            document.querySelectorAll('.delete-fab-product-button').forEach(btn => btn.addEventListener('click', (e) => deleteFabProduct(e.target.dataset.id)));
        }

        function openEditFabProductModal(productId) {
            if (!userId) { showMessage("Acción Requerida", "Por favor, inicie sesión para editar."); return; }
            const product = products.find(p => p.id === productId);
            if (product) {
                editFabProductIdInput.value = product.id;
                editFabProductNameInput.value = product.name;
                editFabProductPriceInput.value = product.price.toFixed(2);
                addStockQuantityInput.value = "0";

                editingFabProductImageBase64 = product.image || null;
                if (product.image) {
                    editFabProductImagePreview.src = product.image;
                    editFabProductImagePreview.classList.remove('hidden');
                    removeEditFabImageButton.classList.remove('hidden');
                } else {
                    editFabProductImagePreview.src = '';
                    editFabProductImagePreview.classList.add('hidden');
                    removeEditFabImageButton.classList.add('hidden');
                }
                editFabProductImageInput.value = '';

                addStockDeductPlasticCheck.checked = !!product.plasticCostPerUnit; 
                addStockPlasticDetailsDiv.classList.toggle('hidden', !addStockDeductPlasticCheck.checked);
                addStockPlasticTypeSelect.value = product.plasticCostPerUnit ? product.plasticCostPerUnit.typeId : '';
                addStockPlasticGramsUnitInput.value = product.plasticCostPerUnit ? product.plasticCostPerUnit.amount : '';
                
                showModal(editFabProductModal);
            }
        }

        saveEditFabButton.addEventListener('click', async () => {
            if (!userId) { showMessage("Acción Requerida", "Por favor, inicie sesión para guardar."); return; }
            const productId = editFabProductIdInput.value;
            const product = products.find(p => p.id === productId);
            if (!product) { showMessage("Error", "Producto no encontrado."); return; }

            const newName = editFabProductNameInput.value.trim();
            const newPrice = parseFloat(editFabProductPriceInput.value);
            if (!newName || isNaN(newPrice) || newPrice < 0) { showMessage("Error", "Nombre y precio válido son requeridos."); return; }

            const additionalQuantity = parseInt(addStockQuantityInput.value);
            if (isNaN(additionalQuantity) || additionalQuantity < 0) { showMessage("Error", "Cantidad adicional debe ser no negativa."); return; }

            const updateData = { name: newName, price: newPrice, image: editingFabProductImageBase64 };
            let plasticUpdateForDb = null;
            let newPlasticCostPerUnitForProduct = product.plasticCostPerUnit; 

            if (additionalQuantity > 0) {
                updateData.stock = product.stock + additionalQuantity;
                if (addStockDeductPlasticCheck.checked) {
                    const plasticTypeId = addStockPlasticTypeSelect.value;
                    const gramsPerUnit = parseFloat(addStockPlasticGramsUnitInput.value);
                    if (!plasticTypeId || isNaN(gramsPerUnit) || gramsPerUnit <= 0) { showMessage("Error", "Para nuevo lote, seleccione plástico y gramos válidos."); return; }
                    
                    const selectedPlastic = plastics.find(p => p.id === plasticTypeId);
                    if (!selectedPlastic) { showMessage("Error", "Tipo de plástico para nuevo lote no válido o no disponible."); return; }
                    
                    const totalPlasticForNewBatch = gramsPerUnit * additionalQuantity;
                    if (selectedPlastic.quantity < totalPlasticForNewBatch) {
                        showMessage("Error", `Stock insuficiente de ${selectedPlastic.name}. Necesita ${totalPlasticForNewBatch}g, disponibles ${selectedPlastic.quantity}g.`);
                        return;
                    }
                    plasticUpdateForDb = { id: selectedPlastic.id, newQuantity: selectedPlastic.quantity - totalPlasticForNewBatch };
                    newPlasticCostPerUnitForProduct = { typeId: plasticTypeId, amount: gramsPerUnit, name: selectedPlastic.name };
                }
            }
            
            if (addStockDeductPlasticCheck.checked) {
                const plasticTypeId = addStockPlasticTypeSelect.value;
                const gramsPerUnit = parseFloat(addStockPlasticGramsUnitInput.value);
                if (plasticTypeId && !isNaN(gramsPerUnit) && gramsPerUnit > 0) {
                    const selectedPlastic = plastics.find(p => p.id === plasticTypeId);
                    if (selectedPlastic) {
                         newPlasticCostPerUnitForProduct = { typeId: plasticTypeId, amount: gramsPerUnit, name: selectedPlastic.name };
                    }
                } else if (!plasticTypeId && (isNaN(gramsPerUnit) || gramsPerUnit <= 0)) { 
                    newPlasticCostPerUnitForProduct = null;
                }
            } else {
                 newPlasticCostPerUnitForProduct = null;
            }
            updateData.plasticCostPerUnit = newPlasticCostPerUnitForProduct;

            try {
                const batch = writeBatch(db);
                batch.update(productDocRef(productId), updateData);
                if (plasticUpdateForDb) {
                    batch.update(plasticDocRef(plasticUpdateForDb.id), { quantity: plasticUpdateForDb.newQuantity });
                }
                await batch.commit();

                hideModal(editFabProductModal);
                showMessage("Éxito", `Producto "${newName}" actualizado. Stock total: ${updateData.stock !== undefined ? updateData.stock : product.stock}.`);
            } catch (error) {
                console.error("Error actualizando producto:", error);
                showMessage("Error de Base de Datos", "No se pudo actualizar el producto: " + error.message);
            }
        });

        async function deleteFabProduct(productId) {
            if (!userId) { showMessage("Acción Requerida", "Por favor, inicie sesión para eliminar."); return; }
            const productToDelete = products.find(p => p.id === productId);
            if (!productToDelete) return;

            const confirmDelete = window.confirm(`¿Seguro que deseas eliminar el producto "${productToDelete.name}" del inventario? Esta acción no se puede deshacer.`);
            if (confirmDelete) {
                try {
                    await deleteDoc(productDocRef(productId));
                    showMessage("Producto Eliminado", `El producto "${productToDelete.name}" ha sido eliminado.`);
                } catch (error) {
                    console.error("Error eliminando producto:", error);
                    showMessage("Error de Base de Datos", "No se pudo eliminar el producto: " + error.message);
                }
            }
        }

        // --- Lógica del Punto de Venta (POS) ---
        function renderProductsForSalePOS() {
            posProductListDiv.innerHTML = '';
            if (!userId) {
                 posProductListDiv.innerHTML = '<p class="text-secondary text-sm col-span-full">Inicie sesión para ver productos disponibles.</p>';
                 return;
            }
            const availableProducts = products.filter(p => p.stock > 0);
            const sortedAvailableProducts = [...availableProducts].sort((a,b) => a.name.localeCompare(b.name));

            if (sortedAvailableProducts.length === 0) {
                posProductListDiv.innerHTML = '<p class="text-secondary text-sm col-span-full">No hay productos disponibles para la venta.</p>';
                return;
            }
            sortedAvailableProducts.forEach(p => {
                const button = document.createElement('button');
                button.className = `card-glass flex flex-col items-center justify-between overflow-hidden hover:border-sky-500 transition-colors`;
                let imageHtml = p.image ? `<img src="${p.image}" alt="${p.name}" class="product-image-sales">` : `<div class="product-image-sales-placeholder"><span>Sin Imagen</span></div>`;
                const textContainerClass = p.image ? 'p-2.5' : 'p-2.5 flex-grow flex flex-col justify-center';
                button.innerHTML = `
                    ${imageHtml}
                    <div class="${textContainerClass} w-full">
                        <span class="text-sm text-main block truncate font-medium">${p.name}</span>
                        <span class="text-xs text-sky-400 mt-1 block">ARS ${p.price.toFixed(2)}</span>
                        <span class="text-xs text-slate-400 mt-1 block">Disp: ${p.stock}</span>
                    </div>
                `;
                button.addEventListener('click', () => addProductToCartPOS(p.id));
                posProductListDiv.appendChild(button);
            });
        }

        function addProductToCartPOS(productId) {
            if (!userId) { showMessage("Acción Requerida", "Por favor, inicie sesión para agregar al carrito."); return; }
            const product = products.find(p => p.id === productId);
            if (product && product.stock > 0) {
                cart.push({...product, cartItemId: `cart_${Date.now()}_${Math.random().toString(36).substr(2,5)}` });
                product.stock--; 
                renderCartPOS();
                renderProductsForSalePOS();
            } else if (product && product.stock <= 0) {
                showMessage("Stock Agotado", `El producto "${product.name}" ya no tiene stock disponible.`);
            }
        }

        function removeProductFromCartPOS(cartItemId) {
            const cartItemIndex = cart.findIndex(item => item.cartItemId === cartItemId);
            if (cartItemIndex > -1) {
                const removedItem = cart[cartItemIndex];
                const productInInventory = products.find(p => p.id === removedItem.id);
                if (productInInventory) {
                    productInInventory.stock++; 
                }
                cart.splice(cartItemIndex, 1);
                renderCartPOS();
                renderProductsForSalePOS();
            }
        }

        function renderCartPOS() {
            posCartItemsDiv.innerHTML = '';
            let currentTotal = 0;
            if (cart.length === 0) {
                posCartItemsDiv.innerHTML = '<p class="text-secondary text-sm">El carrito está vacío.</p>';
            } else {
                cart.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center py-1.5';
                    div.innerHTML = `
                        <span class="text-sm text-label">${item.name}</span>
                        <div class="flex items-center">
                            <span class="text-sm text-main font-medium mr-3">ARS ${item.price.toFixed(2)}</span>
                            <button data-cart-item-id="${item.cartItemId}" class="pos-remove-from-cart-button text-red-400 hover:text-red-300 text-xl p-0 leading-none">&times;</button>
                        </div>
                    `;
                    posCartItemsDiv.appendChild(div);
                    currentTotal += item.price;
                });
            }
            posCartTotalSpan.textContent = `ARS ${currentTotal.toFixed(2)}`;
            posCartTotalSpan.className = currentTotal > 0 ? 'text-green-400' : 'text-slate-400';
            document.querySelectorAll('.pos-remove-from-cart-button').forEach(btn => btn.addEventListener('click', (e) => removeProductFromCartPOS(e.target.dataset.cartItemId)));
        }

        posClearCartButton.addEventListener('click', () => {
            if (!userId) { showMessage("Acción Requerida", "Por favor, inicie sesión."); return; }
            if (cart.length > 0) {
                cart.forEach(cartItem => {
                    const productInInventory = products.find(p => p.id === cartItem.id);
                    if (productInInventory) productInInventory.stock += 1;
                });
                cart = [];
                renderAll(); 
                showMessage("Carrito Vacío", "El carrito ha sido vaciado y el stock visual restaurado.");
            }
        });

        posCheckoutButton.addEventListener('click', async () => {
            if (!userId) { showMessage("Acción Requerida", "Por favor, inicie sesión para finalizar la venta."); return; }
            if (cart.length === 0) {
                showMessage("Venta Vacía", "No hay productos en el carrito.");
                return;
            }
            const saleAmount = cart.reduce((sum, item) => sum + item.price, 0);
            const saleTimestamp = new Date().toISOString();
            const saleItemsForDb = cart.map(item => ({
                productId: item.id,
                name: item.name,
                price: item.price,
                quantity: 1 
            }));

            try {
                const batch = writeBatch(db);
                for (const item of cart) {
                    const productRef = productDocRef(item.id);
                    const productData = products.find(p => p.id === item.id);
                    if (productData) { 
                        batch.update(productRef, { stock: productData.stock });
                    } else {
                        console.warn(`Producto con ID ${item.id} no encontrado en array local durante checkout.`);
                    }
                }
                await batch.commit(); 

                await addDoc(completedSalesCollectionRef(), {
                    items: saleItemsForDb,
                    totalAmount: saleAmount,
                    timestamp: saleTimestamp
                });

                totalSales += saleAmount;
                saveTotalSalesToLocalStorage();

                showMessage("Venta Finalizada", `Venta de ARS ${saleAmount.toFixed(2)} completada. Total del día: ARS ${totalSales.toFixed(2)}.`);
                cart = [];
                renderDailySalesDisplay();
                renderCartPOS();
                
            } catch (error) {
                console.error("Error durante el checkout:", error);
                showMessage("Error de Base de Datos", "No se pudo completar la venta: " + error.message);
                cart.forEach(cartItem => {
                    const productInInventory = products.find(p => p.id === cartItem.id);
                    if (productInInventory) productInInventory.stock++;
                });
                renderAll();
            }
        });

        // --- Opciones de Tienda (Resumen, Reinicio) ---
        resetStoreSalesButton.addEventListener('click', async () => {
            if (!userId) { showMessage("Acción Requerida", "Por favor, inicie sesión."); return; }
            
            const confirmReset = window.confirm("¿Empezar un nuevo día de caja? Se borrarán ventas y carrito. Esta acción no se puede deshacer.");
            if (confirmReset) {
                totalSales = 0;
                localStorage.removeItem(`posTotalSales_${userId}`); 
                
                try {
                    const salesQuery = query(completedSalesCollectionRef());
                    const salesSnapshot = await getDocs(salesQuery);
                    const batch = writeBatch(db);
                    salesSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                } catch (error) {
                    console.error("Error reiniciando ventas del día en Firestore:", error);
                    showMessage("Error de BD", "No se pudieron borrar las ventas anteriores de la BD.");
                }

                if (cart.length > 0) {
                    cart.forEach(cartItem => {
                        const productInInventory = products.find(p => p.id === cartItem.id);
                        if (productInInventory) productInInventory.stock++; 
                    });
                    cart = [];
                }
                
                renderAll(); 
                showMessage('Nuevo Día Iniciado', 'Los contadores de ventas y el carrito han sido reiniciados.');
            }
        });

        generateStoreSummaryButton.addEventListener('click', () => {
            if (!userId) { showMessage("Acción Requerida", "Por favor, inicie sesión para ver el resumen."); return; }
            if (completedSales.length === 0) {
                showMessage('Resumen de Ventas', 'No hay ventas registradas para este período.');
                return;
            }
            const productSummary = {};
            let totalRevenueFromDbSales = 0;
            completedSales.forEach(sale => {
                totalRevenueFromDbSales += sale.totalAmount;
                sale.items.forEach(item => {
                    productSummary[item.productId] = productSummary[item.productId] || { name: item.name, quantity: 0, totalRevenue: 0 };
                    productSummary[item.productId].quantity += item.quantity;
                    productSummary[item.productId].totalRevenue += item.price * item.quantity;
                });
            });
            let summaryText = `<pre><strong>Resumen de Ventas del Día (Firestore)</strong>\n\nTotal Transacciones: ${completedSales.length}\nIngresos Totales: ARS ${totalRevenueFromDbSales.toFixed(2)}\n\n<strong>Detalle por Producto:</strong>\n`;
            Object.values(productSummary).forEach(p => {
                summaryText += `- ${p.name}:\n  Cantidad: ${p.quantity}\n  Ingresos: ARS ${p.totalRevenue.toFixed(2)}\n`;
            });
            if (Object.keys(productSummary).length === 0) summaryText += `No se vendieron productos específicos.\n`;
            summaryText += `\nTotal Ventas (local): ARS ${totalSales.toFixed(2)}</pre>`; 
            showMessage('Resumen de Ventas', summaryText, true);
        });

        // --- Funciones de LocalStorage (User-specific) ---
        function saveTotalSalesToLocalStorage() {
            if (userId) {
                localStorage.setItem(`posTotalSales_${userId}`, JSON.stringify(totalSales));
            }
        }
        function loadTotalSalesFromLocalStorage() {
            if (userId) {
                const storedSales = localStorage.getItem(`posTotalSales_${userId}`);
                totalSales = storedSales ? JSON.parse(storedSales) : 0;
            } else {
                totalSales = 0; 
            }
        }
        
        // --- Renderizado de Ventas del Día ---
        function renderDailySalesDisplay() {
            if (posDailySalesTotalSpan) {
                posDailySalesTotalSpan.textContent = `ARS ${totalSales.toFixed(2)}`;
                posDailySalesTotalSpan.className = totalSales > 0 ? 'text-2xl font-bold text-green-400' : 'text-2xl font-bold text-slate-400';
            }
        }

        // --- Inicialización y Renderizado Global ---
        function renderAll() {
            renderPlasticStock();
            renderFabProductList();
            renderProductsForSalePOS();
            renderCartPOS();
            renderDailySalesDisplay();
        }

        function clearLocalData() {
            plastics = [];
            products = [];
            cart = [];
            completedSales = [];
            totalSales = 0;
            renderAll(); 
        }

        // --- Carga de Datos desde Firestore con onSnapshot ---
        function setupFirestoreListeners() {
            if (!userId) {
                console.warn("UserID no disponible. No se pueden configurar listeners de Firestore.");
                clearLocalData();
                plasticStockListDiv.innerHTML = '<p class="text-secondary text-sm">Inicie sesión para ver/cargar plásticos.</p>';
                fabProductListDiv.innerHTML = '<p class="text-secondary text-sm">Inicie sesión para ver/cargar productos.</p>';
                posProductListDiv.innerHTML = '<p class="text-secondary text-sm col-span-full">Inicie sesión para ver productos disponibles.</p>';
                loadingIndicator.classList.add('hidden');
                return;
            }
            loadingIndicator.textContent = "Cargando datos...";
            loadingIndicator.classList.remove('hidden');

            unsubscribePlastics();
            unsubscribeProducts();
            unsubscribeSales();

            const plasticsQuery = query(plasticsCollectionRef());
            unsubscribePlastics = onSnapshot(plasticsQuery, (snapshot) => {
                plastics = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
                loadingIndicator.classList.add('hidden');
            }, (error) => {
                console.error("Error escuchando cambios en plásticos:", error);
                showMessage("Error de BD", "No se pudo cargar la lista de plásticos: " + error.message);
                loadingIndicator.textContent = "Error cargando plásticos.";
            });

            const productsQuery = query(productsCollectionRef());
            unsubscribeProducts = onSnapshot(productsQuery, (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
                loadingIndicator.classList.add('hidden');
            }, (error) => {
                console.error("Error escuchando cambios en productos:", error);
                showMessage("Error de BD", "No se pudo cargar la lista de productos: " + error.message);
                loadingIndicator.textContent = "Error cargando productos.";
            });

            const salesQuery = query(completedSalesCollectionRef());
            unsubscribeSales = onSnapshot(salesQuery, (snapshot) => {
                completedSales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                loadTotalSalesFromLocalStorage(); 
                renderDailySalesDisplay(); 
                loadingIndicator.classList.add('hidden');
            }, (error) => {
                console.error("Error escuchando cambios en ventas completadas:", error);
                loadingIndicator.textContent = "Error cargando historial de ventas.";
            });
        }
        
        async function initializeAppCore() {
            loadingIndicator.classList.remove('hidden');
            loadingIndicator.textContent = "Verificando sesión...";
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userInfoDisplay.textContent = user.displayName || user.email || "Usuario Autenticado";
                    userInfoDisplay.classList.remove('hidden');
                    googleSigninButton.classList.add('hidden');
                    signoutButton.classList.remove('hidden');
                    
                    console.log("Usuario autenticado:", userId, user.email);
                    loadingIndicator.textContent = "Cargando datos...";
                    setupFirestoreListeners();
                    loadTotalSalesFromLocalStorage(); 
                    renderDailySalesDisplay();
                } else {
                    userId = null;
                    userInfoDisplay.textContent = "";
                    userInfoDisplay.classList.add('hidden');
                    googleSigninButton.classList.remove('hidden');
                    signoutButton.classList.add('hidden');
                    
                    console.log("Usuario no autenticado.");
                    loadingIndicator.classList.add('hidden'); 
                    clearLocalData(); 
                    plasticStockListDiv.innerHTML = '<p class="text-secondary text-sm">Inicie sesión para ver/cargar plásticos.</p>';
                    fabProductListDiv.innerHTML = '<p class="text-secondary text-sm">Inicie sesión para ver/cargar productos.</p>';
                    posProductListDiv.innerHTML = '<p class="text-secondary text-sm col-span-full">Inicie sesión para ver productos disponibles.</p>';

                    unsubscribePlastics();
                    unsubscribeProducts();
                    unsubscribeSales();
                }
            });

            const activeTabId = localStorage.getItem('activeStoreTab') || 'tab-inventario';
            const buttonToActivate = document.getElementById(activeTabId) || tabInventarioButton;
            const contentToActivate = activeTabId === 'tab-pos' ? contentPos : contentInventario;
            setActiveTab(buttonToActivate, contentToActivate);
        }

        // Event Listeners para Pestañas
        tabInventarioButton.addEventListener('click', () => setActiveTab(tabInventarioButton, contentInventario));
        tabPosButton.addEventListener('click', () => {
            setActiveTab(tabPosButton, contentPos);
            if (userId) renderProductsForSalePOS(); 
        });

        document.addEventListener('DOMContentLoaded', initializeAppCore);
    </script>
</body>
</html>
